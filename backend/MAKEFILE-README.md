# Makefile ä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

æœ¬ Makefile æä¾›äº†ä¸€ç³»åˆ—ä¾¿æ·å‘½ä»¤ï¼Œç”¨äºç®¡ç† AI Overview é¡¹ç›®çš„åç«¯æœåŠ¡ã€‚ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ç¯å¢ƒå˜é‡é…ç½®ã€Docker Compose æœåŠ¡ç®¡ç†ä»¥åŠé•œåƒæ¸…ç†ç­‰ã€‚

## å‰ç½®æ¡ä»¶

- å·²å®‰è£… Docker å’Œ Docker Compose v2+
- å·²å…‹éš†é¡¹ç›®ä»£ç åº“
- å½“å‰å·¥ä½œç›®å½•(æ ¹æ®è‡ªå·±çš„é¡¹ç›®è·¯å¾„)ï¼š`/workplace/mysystem/ai-overview/backend`

## ç¯å¢ƒå˜é‡é…ç½®

### 1. åˆå§‹åŒ–ç¯å¢ƒæ–‡ä»¶

```bash
make env-init
```

- **åŠŸèƒ½**ï¼šåˆ›å»º `.env` æ–‡ä»¶å¹¶è®¾ç½®é»˜è®¤å€¼
- **ä½¿ç”¨åœºæ™¯**ï¼šé¦–æ¬¡ä½¿ç”¨é¡¹ç›®æ—¶åˆå§‹åŒ–ç¯å¢ƒé…ç½®
- **è¾“å‡ºç¤ºä¾‹**ï¼š
  ```
  åˆ›å»º .env æ–‡ä»¶...
  âœ… è¯·ç¼–è¾‘ .env æ–‡ä»¶è®¾ç½®ä½ çš„ DEEPSEEK_API_KEY
  ```
  æˆ–
  ```
  âœ… .env æ–‡ä»¶å·²å­˜åœ¨
  ```

### 2. æ£€æŸ¥ API Key é…ç½®

```bash
make check-env
```

- **åŠŸèƒ½**ï¼šéªŒè¯ `.env` æ–‡ä»¶ä¸­çš„ `DEEPSEEK_API_KEY` æ˜¯å¦æ­£ç¡®è®¾ç½®
- **ä½¿ç”¨åœºæ™¯**ï¼šåœ¨å¯åŠ¨æœåŠ¡å‰ç¡®ä¿ API Key å·²é…ç½®
- **è¾“å‡ºç¤ºä¾‹**ï¼š
  ```
  âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡
  ```
  æˆ–
  ```
  âŒ é”™è¯¯: è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® DEEPSEEK_API_KEY
  ğŸ’¡ è¿è¡Œ: make env-init ç„¶åç¼–è¾‘ .env æ–‡ä»¶
  ```

## Docker Compose æœåŠ¡ç®¡ç†

### 3. åœæ­¢æ‰€æœ‰æœåŠ¡

```bash
make docker-compose-stop
```

- **åŠŸèƒ½**ï¼šåœæ­¢å¹¶ç§»é™¤æ‰€æœ‰æœåŠ¡å®¹å™¨ï¼ˆä¿ç•™ç½‘ç»œå’Œå·ï¼‰
- **ä½¿ç”¨åœºæ™¯**ï¼šéœ€è¦ä¸´æ—¶åœæ­¢æœåŠ¡æ—¶
- **è¾“å‡ºç¤ºä¾‹**ï¼š
  ```
  === åœæ­¢æ‰€æœ‰æœåŠ¡ ===
  âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢
  ```

### 4. æ¸…ç†å®¹å™¨å’Œç½‘ç»œï¼ˆä¿ç•™æ•°æ®å·ï¼‰

```bash
make docker-compose-clean
```

- **åŠŸèƒ½**ï¼šåœæ­¢å¹¶ç§»é™¤å®¹å™¨å’Œç½‘ç»œï¼Œä¿ç•™æ•°æ®å·
- **ä½¿ç”¨åœºæ™¯**ï¼šéœ€è¦æ¸…ç†è¿è¡Œç¯å¢ƒä½†ä¿ç•™æ•°æ®æ—¶
- **è¾“å‡ºç¤ºä¾‹**ï¼š
  ```
  === æ¸…ç†å®¹å™¨å’Œç½‘ç»œï¼ˆä¿ç•™å·ï¼‰ ===
  âœ… å®¹å™¨å’Œç½‘ç»œå·²æ¸…ç†ï¼Œå·å·²ä¿ç•™
  ```

### 5. å®Œå…¨æ¸…ç†æ‰€æœ‰èµ„æºï¼ˆåŒ…æ‹¬æ•°æ®å·ï¼‰

```bash
make docker-compose-clean-full
```

- **åŠŸèƒ½**ï¼šåœæ­¢å¹¶ç§»é™¤æ‰€æœ‰å®¹å™¨ã€ç½‘ç»œå’Œæ•°æ®å·
- **ä½¿ç”¨åœºæ™¯**ï¼šéœ€è¦å®Œå…¨é‡ç½®å¼€å‘ç¯å¢ƒæ—¶
- **æ³¨æ„**ï¼šæ­¤æ“ä½œä¼šåˆ é™¤æ‰€æœ‰æŒä¹…åŒ–æ•°æ®ï¼ˆæ•°æ®åº“ã€ç›‘æ§æ•°æ®ç­‰ï¼‰
- **è¾“å‡ºç¤ºä¾‹**ï¼š
  ```
  === å®Œå…¨æ¸…ç†æ‰€æœ‰èµ„æºï¼ˆåŒ…æ‹¬å·ï¼‰ ===
  âœ… æ‰€æœ‰èµ„æºï¼ˆåŒ…æ‹¬å·ï¼‰å·²æ¸…ç†
  ```

### 6. å¯åŠ¨æœåŠ¡ï¼ˆä¸é‡æ–°æ„å»ºï¼‰

```bash
make docker-compose-up
```

- **åŠŸèƒ½**ï¼šå¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä½¿ç”¨å·²æœ‰é•œåƒï¼Œä¸é‡æ–°æ„å»ºï¼‰
- **ä½¿ç”¨åœºæ™¯**ï¼šä»£ç æœªä¿®æ”¹ï¼Œä»…éœ€é‡å¯æœåŠ¡æ—¶
- **è¾“å‡ºç¤ºä¾‹**ï¼š
  ```
  === å¯åŠ¨æœåŠ¡ ===
  âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨
  ğŸ“Š æŸ¥çœ‹æ—¥å¿—: docker compose -f ../docker-compose.yml logs -f
  ğŸŒ åç«¯è®¿é—®åœ°å€: http://localhost:8090
  ğŸ“ˆ Prometheusè®¿é—®åœ°å€: http://localhost:9090
  ğŸ“Š Grafanaè®¿é—®åœ°å€: http://localhost:3000
  ```

### 7. æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ï¼ˆä¸€æ­¥å®Œæˆï¼‰

```bash
make docker-compose-up-build
```

- **åŠŸèƒ½**ï¼šæ™ºèƒ½æ„å»ºæœ‰å˜åŒ–çš„é•œåƒå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
- **ä½¿ç”¨åœºæ™¯**ï¼šä¿®æ”¹ä»£ç åéœ€è¦é‡æ–°æ„å»ºå¹¶å¯åŠ¨æœåŠ¡æ—¶ï¼ˆæ¨èæ—¥å¸¸ä½¿ç”¨ï¼‰
- **ç‰¹ç‚¹**ï¼šä»…é‡æ–°æ„å»ºæœ‰å˜åŒ–çš„æœåŠ¡ï¼Œæé«˜æ•ˆç‡
- **è¾“å‡ºç¤ºä¾‹**ï¼š
  ```
  === æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ï¼ˆä¸€æ­¥å®Œæˆï¼‰ ===
  âœ… æ‰€æœ‰æœåŠ¡å·²æ„å»ºå¹¶å¯åŠ¨
  ğŸ“Š æŸ¥çœ‹æ—¥å¿—: docker compose -f ../docker-compose.yml logs -f
  ğŸŒ åç«¯è®¿é—®åœ°å€: http://localhost:8090
  ğŸ“ˆ Prometheusè®¿é—®åœ°å€: http://localhost:9090
  ğŸ“Š Grafanaè®¿é—®åœ°å€: http://localhost:3000
  ```

## ç›‘æ§ä¸ç»´æŠ¤

### 8. æŸ¥çœ‹æœåŠ¡æ—¥å¿—

```bash
make docker-compose-logs
```

- **åŠŸèƒ½**ï¼šäº¤äº’å¼æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼Œæ”¯æŒæŸ¥çœ‹æŒ‡å®šæœåŠ¡æˆ–æ‰€æœ‰æœåŠ¡
- **ä½¿ç”¨åœºæ™¯**ï¼šè°ƒè¯•æœåŠ¡é—®é¢˜æˆ–ç›‘æ§æœåŠ¡è¿è¡ŒçŠ¶æ€
- **äº¤äº’ç¤ºä¾‹**ï¼š
  ```
  === æŸ¥çœ‹æœåŠ¡æ—¥å¿— ===
  è¯·è¾“å…¥è¦æŸ¥çœ‹çš„æœåŠ¡åç§°ï¼ˆç•™ç©ºæŸ¥çœ‹æ‰€æœ‰ï¼‰: backend
  ```

### 9. æŸ¥çœ‹å®¹å™¨çŠ¶æ€

```bash
make docker-compose-status
```

- **åŠŸèƒ½**ï¼šæŸ¥çœ‹æ‰€æœ‰æœåŠ¡å®¹å™¨çš„è¿è¡ŒçŠ¶æ€
- **ä½¿ç”¨åœºæ™¯**ï¼šå¿«é€Ÿæ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
- **è¾“å‡ºç¤ºä¾‹**ï¼š
  ```
  === å®¹å™¨çŠ¶æ€ ===
  NAME                     COMMAND                  SERVICE             STATUS              PORTS
  ai-overview-backend-1    "java -jar /app/ai-dâ€¦"   backend             running             0.0.0.0:8090->8090/tcp
  ai-overview-grafana-1    "/run.sh"                grafana             running             0.0.0.0:3000->3000/tcp
  ai-overview-prometheus-1 "/bin/prometheus --câ€¦"   prometheus          running             0.0.0.0:9090->9090/tcp
  ```

### 10. æ¸…ç†æ‚¬ç©º Docker é•œåƒ

```bash
make docker-clean-images-dangling
```

- **åŠŸèƒ½**ï¼šæ¸…ç†æ— æ ‡ç­¾ä¸”æœªè¢«ä»»ä½•å®¹å™¨ä½¿ç”¨çš„é•œåƒï¼ˆæ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸­é—´é•œåƒï¼‰
- **ä½¿ç”¨åœºæ™¯**ï¼šé‡Šæ”¾ç£ç›˜ç©ºé—´ï¼Œä¸å½±å“æ­£åœ¨è¿è¡Œçš„æœåŠ¡
- **è¾“å‡ºç¤ºä¾‹**ï¼š
  ```
  === æ¸…ç†æ‚¬ç©ºé•œåƒï¼ˆæ— æ ‡ç­¾ä¸”æœªä½¿ç”¨ï¼‰ ===
  âœ… æ‚¬ç©ºé•œåƒå·²æ¸…ç†
  ```

### 11. æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„ Docker é•œåƒ

```bash
make docker-clean-images-unused
```

- **åŠŸèƒ½**ï¼šæ¸…ç†æ‰€æœ‰æœªè¢«ä»»ä½•å®¹å™¨ä½¿ç”¨çš„é•œåƒï¼ˆåŒ…æ‹¬æœ‰æ ‡ç­¾ä½†æœªä½¿ç”¨çš„é•œåƒï¼‰
- **ä½¿ç”¨åœºæ™¯**ï¼šéœ€è¦æ›´å¤šç£ç›˜ç©ºé—´æ—¶
- **è¾“å‡ºç¤ºä¾‹**ï¼š
  ```
  === æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒï¼ˆä¸å½±å“å®¹å™¨å’Œå·ï¼‰ ===
  âœ… æœªä½¿ç”¨çš„é•œåƒå·²æ¸…ç†
  ```

## å¸¸ç”¨å·¥ä½œæµç¤ºä¾‹

### 1. é¦–æ¬¡ä½¿ç”¨é¡¹ç›®

```bash
make env-init
# ç¼–è¾‘ .env æ–‡ä»¶è®¾ç½® DEEPSEEK_API_KEY
make check-env
make docker-compose-up-build
```

### 2. æ—¥å¸¸å¼€å‘æµç¨‹

```bash
# ä¿®æ”¹ä»£ç å
git add .
git commit -m "ä¿®æ”¹è¯´æ˜"
make docker-compose-up-build  # æ™ºèƒ½æ„å»ºå¹¶å¯åŠ¨
make docker-compose-status    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
make docker-compose-logs      # æŸ¥çœ‹æ—¥å¿—
```

### 3. æ¸…ç†æ— ç”¨é•œåƒ

```bash
# å®‰å…¨æ¸…ç†ï¼ˆä»…æ¸…ç†æ‚¬ç©ºé•œåƒï¼‰
make docker-clean-images-dangling

# å½»åº•æ¸…ç†ï¼ˆæ¸…ç†æ‰€æœ‰æœªä½¿ç”¨é•œåƒï¼‰
make docker-clean-images-unused
```

### 4. é‡ç½®å¼€å‘ç¯å¢ƒ

```bash
# ä¿ç•™æ•°æ®å·çš„é‡ç½®
make docker-compose-clean
make docker-compose-up-build

# å®Œå…¨é‡ç½®ï¼ˆåŒ…æ‹¬æ•°æ®ï¼‰
make docker-compose-clean-full
make docker-compose-up-build
```

## æ³¨æ„äº‹é¡¹

1. **API Key å®‰å…¨**ï¼šè¯·å¦¥å–„ä¿ç®¡ä½ çš„ DEEPSEEK_API_KEYï¼Œä¸è¦æ³„éœ²åˆ°ä»£ç ä»“åº“ä¸­
2. **æ•°æ®å·æ¸…ç†**ï¼š`docker-compose-clean-full` ä¼šåˆ é™¤æ‰€æœ‰æŒä¹…åŒ–æ•°æ®ï¼Œè¯·è°¨æ…ä½¿ç”¨
3. **é•œåƒé€‰æ‹©**ï¼š`docker-compose-up-build` ä»…é‡æ–°æ„å»ºæœ‰å˜åŒ–çš„æœåŠ¡ï¼Œæ•ˆç‡æ›´é«˜
4. **æ—¥å¿—æŸ¥çœ‹**ï¼šæŒ‰ `Ctrl+C` å¯é€€å‡ºæ—¥å¿—æŸ¥çœ‹æ¨¡å¼
5. **é»˜è®¤é…ç½®**ï¼šDocker Compose æ–‡ä»¶é»˜è®¤ä½¿ç”¨ `../docker-compose.yml`

## å‘½ä»¤åˆ—è¡¨

| å‘½ä»¤ | åŠŸèƒ½æè¿° |
|------|----------|
| `env-init` | åˆå§‹åŒ–ç¯å¢ƒæ–‡ä»¶ |
| `check-env` | æ£€æŸ¥ API Key é…ç½® |
| `docker-compose-stop` | åœæ­¢æ‰€æœ‰æœåŠ¡ |
| `docker-compose-clean` | æ¸…ç†å®¹å™¨å’Œç½‘ç»œï¼ˆä¿ç•™å·ï¼‰ |
| `docker-compose-clean-full` | å®Œå…¨æ¸…ç†æ‰€æœ‰èµ„æºï¼ˆåŒ…æ‹¬å·ï¼‰ |
| `docker-compose-up` | å¯åŠ¨æœåŠ¡ï¼ˆä¸é‡æ–°æ„å»ºï¼‰ |
| `docker-compose-up-build` | æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ï¼ˆä¸€æ­¥å®Œæˆï¼‰ |
| `docker-compose-logs` | æŸ¥çœ‹æœåŠ¡æ—¥å¿— |
| `docker-compose-status` | æŸ¥çœ‹å®¹å™¨çŠ¶æ€ |
| `docker-clean-images-dangling` | æ¸…ç†æ‚¬ç©ºé•œåƒ |
| `docker-clean-images-unused` | æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨é•œåƒ |