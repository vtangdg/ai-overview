## æ¡ä»¶å¯¼å…¥ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼‰
ifneq (,$(wildcard .env))
include .env
export
endif

## å˜é‡å®šä¹‰
DEEPSEEK_API_KEY ?= your_api_key_here_please_set_in_env_file
IMAGE_NAME ?= ai-overview-backend
IMAGE_TAG ?= latest
CONTAINER_NAME ?= ai-overview-backend
HOST_PORT ?= 8090
CONTAINER_PORT ?= 8090

## åˆå§‹åŒ–ç¯å¢ƒæ–‡ä»¶
env-init:
	@if [ ! -f .env ]; then \
		echo "åˆ›å»º .env æ–‡ä»¶..."; \
		echo "DEEPSEEK_API_KEY=your_api_key_here_please_set_in_env_file" > .env; \
		echo "âœ… è¯·ç¼–è¾‘ .env æ–‡ä»¶è®¾ç½®ä½ çš„ DEEPSEEK_API_KEY"; \
	else \
		echo "âœ… .env æ–‡ä»¶å·²å­˜åœ¨"; \
	fi

## æ£€æŸ¥ API Key
check-env:
	@if [ "$(DEEPSEEK_API_KEY)" = "your_api_key_here_please_set_in_env_file" ]; then \
		echo "âŒ é”™è¯¯: è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® DEEPSEEK_API_KEY"; \
		echo "ğŸ’¡ è¿è¡Œ: make env-init ç„¶åç¼–è¾‘ .env æ–‡ä»¶"; \
		exit 1; \
	fi
	@echo "âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡"

## Docker remove and build images (å®Œæ•´æ¸…ç†å’Œæ„å»º)
docker-remove-build:
	@echo "=== æ¸…ç†å¹¶é‡æ–°æ„å»ºé•œåƒ ==="
	@echo "1. åœæ­¢å¹¶åˆ é™¤ç°æœ‰å®¹å™¨..."
	-@docker stop $(CONTAINER_NAME) 2>/dev/null || echo "æ— è¿è¡Œä¸­çš„å®¹å™¨"
	-@docker rm $(CONTAINER_NAME) 2>/dev/null || echo "æ— å®¹å™¨å¯åˆ é™¤"
	@echo "2. åˆ é™¤ç°æœ‰é•œåƒ..."
	-@docker rmi $(IMAGE_NAME):$(IMAGE_TAG) 2>/dev/null || echo "æ— é•œåƒå¯åˆ é™¤"
	@echo "3. æ„å»ºæ–°é•œåƒ..."
	@docker build -t $(IMAGE_NAME):$(IMAGE_TAG) .
	@echo "âœ… é•œåƒæ„å»ºå®Œæˆ: $(IMAGE_NAME):$(IMAGE_TAG)"

## Docker æ„å»ºé•œåƒ (ç›´æ¥æ„å»º)
docker-build:
	@echo "=== æ„å»ºé•œåƒ ==="
	@docker build -t $(IMAGE_NAME):$(IMAGE_TAG) .
	@echo "âœ… é•œåƒæ„å»ºå®Œæˆ: $(IMAGE_NAME):$(IMAGE_TAG)"

## Docker è¿è¡Œå®¹å™¨
docker-run: check-env
	@echo "=== å¯åŠ¨å®¹å™¨ ==="
	@echo "1. æ¸…ç†ç°æœ‰å®¹å™¨..."
	-@docker stop $(CONTAINER_NAME) 2>/dev/null || echo "æ— è¿è¡Œä¸­çš„å®¹å™¨"
	-@docker rm $(CONTAINER_NAME) 2>/dev/null || echo "æ— å®¹å™¨å¯åˆ é™¤"
	@echo "2. å¯åŠ¨æ–°å®¹å™¨..."
	@docker run -d \
		-p $(HOST_PORT):$(CONTAINER_PORT) \
		-e DEEPSEEK_API_KEY=$(DEEPSEEK_API_KEY) \
		--name $(CONTAINER_NAME) \
		$(IMAGE_NAME):$(IMAGE_TAG)
	@echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸ!"
	@echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—: docker logs -f $(CONTAINER_NAME)"
	@echo "ğŸŒ è®¿é—®åœ°å€: http://localhost:$(HOST_PORT)"

## å…¶ä»–ç›®æ ‡ä¿æŒä¸å˜...
docker-remove-build-run: docker-remove-build docker-run
	@echo "âœ… å®Œæ•´æµç¨‹æ‰§è¡Œå®Œæ¯•!"

.PHONY: docker-remove-build docker-build  docker-run docker-remove-build-run check-env env-init