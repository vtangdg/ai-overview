## æ¡ä»¶å¯¼å…¥ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼‰
ifneq (,$(wildcard .env))
include .env
export
endif

## å˜é‡å®šä¹‰
DEEPSEEK_API_KEY ?= your_api_key_here_please_set_in_env_file
GLM_API_KEY ?= your_api_key_here_please_set_in_env_file
DOCKER_COMPOSE_FILE ?= ../docker-compose.yml

## åˆå§‹åŒ–ç¯å¢ƒæ–‡ä»¶
env-init:
	@if [ ! -f .env ]; then \
		echo "åˆ›å»º .env æ–‡ä»¶..."; \
		echo "DEEPSEEK_API_KEY=your_api_key_here_please_set_in_env_file" > .env; \
		echo "GLM_API_KEY=your_api_key_here_please_set_in_env_file" >> .env; \
		echo "âœ… è¯·ç¼–è¾‘ .env æ–‡ä»¶è®¾ç½®ä½ çš„ DEEPSEEK_API_KEY å’Œ GLM_API_KEY"; \
	else \
		echo "âœ… .env æ–‡ä»¶å·²å­˜åœ¨"; \
	fi

## æ£€æŸ¥ API Key
check-env:
	@if [ "$(DEEPSEEK_API_KEY)" = "your_api_key_here_please_set_in_env_file" ]; then \
		echo "âŒ é”™è¯¯: è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® DEEPSEEK_API_KEY"; \
		echo "ğŸ’¡ è¿è¡Œ: make env-init ç„¶åç¼–è¾‘ .env æ–‡ä»¶"; \
		exit 1; \
	fi
	@if [ "$(GLM_API_KEY)" = "your_api_key_here_please_set_in_env_file" ]; then \
		echo "âŒ é”™è¯¯: è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® GLM_API_KEY"; \
		echo "ğŸ’¡ è¿è¡Œ: make env-init ç„¶åç¼–è¾‘ .env æ–‡ä»¶"; \
		exit 1; \
	fi
	@echo "âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡"

## Docker Compose åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose-stop:
	@echo "=== åœæ­¢æ‰€æœ‰æœåŠ¡ ==="
	@docker compose -f $(DOCKER_COMPOSE_FILE) down
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"

## Docker Compose æ¸…ç†å®¹å™¨å’Œç½‘ç»œï¼ˆä¿ç•™å·ï¼‰
docker-compose-clean:
	@echo "=== æ¸…ç†å®¹å™¨å’Œç½‘ç»œï¼ˆä¿ç•™å·ï¼‰ ==="
	@docker compose -f $(DOCKER_COMPOSE_FILE) down --remove-orphans
	@echo "âœ… å®¹å™¨å’Œç½‘ç»œå·²æ¸…ç†ï¼Œå·å·²ä¿ç•™"

## Docker Compose å®Œå…¨æ¸…ç†æ‰€æœ‰èµ„æºï¼ˆåŒ…æ‹¬å·å’Œç½‘ç»œï¼‰
docker-compose-clean-full:
	@echo "=== å®Œå…¨æ¸…ç†æ‰€æœ‰èµ„æºï¼ˆåŒ…æ‹¬å·ï¼‰ ==="
	@docker compose -f $(DOCKER_COMPOSE_FILE) down -v --remove-orphans
	@echo "âœ… æ‰€æœ‰èµ„æºï¼ˆåŒ…æ‹¬å·ï¼‰å·²æ¸…ç†"

## Docker Compose å¯åŠ¨æœåŠ¡
docker-compose-up:
	@echo "=== å¯åŠ¨æœåŠ¡ ==="
	@docker compose -f $(DOCKER_COMPOSE_FILE) up -d
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨"
	@echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—: docker compose -f $(DOCKER_COMPOSE_FILE) logs -f"
	@echo "ğŸŒ åç«¯è®¿é—®åœ°å€: http://localhost:8090"
	@echo "ğŸ“ˆ Prometheusè®¿é—®åœ°å€: http://localhost:9090"
	@echo "ğŸ“Š Grafanaè®¿é—®åœ°å€: http://localhost:3000"

## Docker Compose æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ï¼ˆä¸€æ­¥å®Œæˆï¼‰
docker-compose-up-build:
	@echo "=== æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ï¼ˆä¸€æ­¥å®Œæˆï¼‰ ==="
	@docker compose -f $(DOCKER_COMPOSE_FILE) up --build -d
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²æ„å»ºå¹¶å¯åŠ¨"
	@echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—: docker compose -f $(DOCKER_COMPOSE_FILE) logs -f"
	@echo "ğŸŒ åç«¯è®¿é—®åœ°å€: http://localhost:8090"
	@echo "ğŸ“ˆ Prometheusè®¿é—®åœ°å€: http://localhost:9090"
	@echo "ğŸ“Š Grafanaè®¿é—®åœ°å€: http://localhost:3000"

## Docker Compose æŸ¥çœ‹æ—¥å¿—
docker-compose-logs:
	@echo "=== æŸ¥çœ‹æœåŠ¡æ—¥å¿— ==="
	@read -p "è¯·è¾“å…¥è¦æŸ¥çœ‹çš„æœåŠ¡åç§°ï¼ˆç•™ç©ºæŸ¥çœ‹æ‰€æœ‰ï¼‰: " service; \
	if [ -n "$$service" ]; then \
		docker compose -f $(DOCKER_COMPOSE_FILE) logs -f $$service; \
	else \
		docker compose -f $(DOCKER_COMPOSE_FILE) logs -f; \
	fi

## æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker-compose-status:
	@echo "=== å®¹å™¨çŠ¶æ€ ==="
	@docker compose -f $(DOCKER_COMPOSE_FILE) ps

## æ¸…ç†æ‚¬ç©º Docker é•œåƒï¼ˆæ— æ ‡ç­¾ä¸”æœªä½¿ç”¨ï¼‰
docker-clean-images-dangling:
	@echo "=== æ¸…ç†æ‚¬ç©ºé•œåƒï¼ˆæ— æ ‡ç­¾ä¸”æœªä½¿ç”¨ï¼‰ ==="
	@docker image prune -f
	@echo "âœ… æ‚¬ç©ºé•œåƒå·²æ¸…ç†"

## æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„ Docker é•œåƒï¼ˆä¸å½±å“å®¹å™¨å’Œå·ï¼‰
docker-clean-images-unused:
	@echo "=== æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒï¼ˆä¸å½±å“å®¹å™¨å’Œå·ï¼‰ ==="
	@docker image prune -af
	@echo "âœ… æœªä½¿ç”¨çš„é•œåƒå·²æ¸…ç†"

.PHONY: env-init check-env docker-compose-stop docker-compose-clean docker-compose-clean-full docker-compose-up docker-compose-up-build docker-compose-logs docker-compose-status docker-clean-images-dangling docker-clean-images-unused